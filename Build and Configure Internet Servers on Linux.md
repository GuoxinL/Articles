## Linux 系统服务器搭建与配置

### Samba 服务器

**跨平台通信，实现不同操作系统之间的资源共享**

#### 应用环境：

* 文件和打印机共享
	使用 SMB 进程实现文件和打印机共享是 Samba 的主要功能

* 身份验证和权限设置
	smbd 服务支持身份验证和权限设置模式，通过加密方式保护共享文件和打印机

* 名称解析
	nmbd 服务可以搭建 NBNS（NetBIOS Name Service）服务器，将计算机的 NetBIOS 名解析为 IP 地址

* 浏览服务
	局域网中，可配置 Samba 服务器为本地主浏览服务器，保存可用资源列表

#### 工作原理

> 基于 SMB 通信协议，直接运行于 TCP/IP 协议之上，使用 445 端口

* 工作流程
	
1. 协议协商

	客户端发送支持的 SMB 协议类型，服务器选择最最优的 SMB 类型并回应

2. 建立连接

	通过身份验证后，服务器为客户端分配唯一的 UID，开始通信

3. 访问共享资源

	客户端发送 tree connect 指令请求资源，服务器为资源访问连接分配 TID，开始访问

4. 断开连接

	客户端发送 tree disconnect 指令关闭共享，服务器断开连接

* 相关进程

	nmbd：进行 NetBIOS 名解析，并提供浏览服务，显示网络上的共享资源列表

	smbd：管理网络上的共享资源

### NFS 服务器

**Network File System 网络文件系统，可在 Linux 系统间实现资源共享**

> NFS 无固定工作端口，需要配合 RPC (Remote Procedure Call 远程进程调用，固定工作端口 111) 服务使用

#### NFS & RPC 工作过程

1. NFS 启动时，自动选择小于 1024 的可用端口，并向 RPC 服务注册

2. 客户端请求 NFS 时，首先向 RPC 查询 NFS 工作端口

3. RPC 返回 NFS 工作端口给客户端

4. 客户端访问 NFS 工作端口，请求服务

5. 经过权限验证，NFS 服务器与客户端建立连接

### DCHP 服务器

**Dynamic Host Configuration Protocol 动态主机配置协议，自动为客户端配置 IP 地址**

> 基于客户/服务器模式，运行在 TCP/IP 协议之上

#### 工作过程

1. DHCP 客户端发送 IP 租约请求
	
	客户端启动网络时，TCP/IP 地址与 0.0.0.0 绑定。客户端发送一个 DHCP Discover 广播信息到本地子网，发送至 UDP 端口 67。

2. DHCP 服务器提供 IP 地址

	DHCP 服务器保留预分配地址并发送 DHCP Offer 信息包广播至 UDP 端口 68，该信息包含 IP 地址、子网掩码、DHCP 服务器 IP 地址、租用期限等信息。

3. DHCP 客户端进行 IP 租用选择

	客户端通常对第一个 DHCP Offer 信息包产生响应，并发送 DHCP Request 信息包广播。未被采用的 DHCP 服务器会将预留的 IP 地址回收。

4. DHCP 服务器认可 IP 租用

	服务器接收到客户端采用的 DHCP Request 信息后，会发送一个 DHCP Acknowledge 信息包广播，信息包含了客户端请求的信息。

#### IP 地址租约和更新

> 客户端从 DHCP 服务器取得 IP 地址后，本次租约行为就会被记录到主机的租赁信息文件中，并开始租约计时。

1. IP 地址租约
	
	* 限定租期。DHCP 服务器提供给客户端的租约是有期限的，当租约到期客户端没有更新租约，则 DCHP 服务器将回收该 IP 地址。

	* 永久租用。DHCP 服务器提供给客户端的租约是永久使用的。

2. 租约更新

	* 更新。租期过了 50% 或者接近 87.5% 时，客户端会发送包含 DHCP Request 的 UDP 信息给 DHCP 服务器，询问是否能保持 TCP/IP 配置信息并更新租期。如果服务可用 DHCP 服务器会发送一个 DHCP Acknowledge 信息给客户端，并更新租期。

	* 重新捆绑。如果在租期 87.5% 时更新租约失败，客户端会尝试与任何一个 DHCP 服务器联系并获得一个有效的 IP 地址，重新进入捆绑状态。如果客户端当前的 IP 地址租用期满，客户端必须放弃该 IP 地址，并重新进入初始化状态，重复整个 DHCP 工作过程。

> 客户端在租约期内，会在租期 50% 与 接近 87.5% 时与服务器联系并决定下一步动作。 

3. 解约条件

	* 客户端租约到期。客户端 IP 地址租用期满，且没有成功更新租约，DHCP 服务器将会回收该 IP 地址。

	* 客户端离线。当客户端进行关闭网络接口（禁用网卡）、关机或重启等操作时，会造成客户端离线。此时，DHCP 服务器会将 IP 地址回收。

#### DHCP 服务器分配的 IP 地址类型

1. 动态 IP 地址

	DHCP 动态地为客户端分配 IP 地址。在 IP 地址有限的单位内，动态 IP 地址可以最大化地利用资源。

2. 固定 IP 地址

	DHCP 服务器记录特定计算机的 MAC 地址，然后为其分配一个固定的 IP 地址。

> 查询 MAC 地址方法：
> 
> 查询本机：
> 
> ifconfig 命令
> 
> 查询远程计算机：
> 
> ping c 1 远程计算机 IP 地址 		// ping 命令连接远程计算机
> 
> arp -n 							// 查询缓存在本地的远程计算机中的 MAC 地址

#### DHCP 服务器规划

1. 小型网络 DHCP 服务器

	如果网络规模在几十台计算机并且网络拓扑结构简单，采用 DHCP 服务器就是个不错的选择。在规划 DHCP 服务器的同时需要注意以下两点:

	* DHCP 服务器硬件设备选择。

		DHCP 服务器需要长时间运行，所以要选择性能稳定的计算机搭建。

	* 计算机 IP 获取方式规划。

		确定哪些计算机需要采用动态 IP 地址配置，哪些计算机、服务器及网络设备采用静态 IP 地址配置。

2. 大型网络 DHCP 服务器

	如果网络中存在大量计算机，为了管理和维护的方便，我们应该配置 DHCP 服务器来动态分配 IP 地址。在规划同时需要考虑以下几点：

	* DHCP 服务器位置。

		客户端在每次获取 IP 地址时需要发送 DHCP Discover 消息广播，如果在一段时间内没有接到 DHCP 服务器的响应，将继续发送消息广播。这样会造成网络带宽的浪费。所以为了缩短 DHCP 服务器的响应时间，应选择适当的介入位置，尽量使服务器连接网络核心位置。

	* DHCP 服务器作用域设置。

		根据不同的需求特点设计合适的作用域，并进行租约、网关及 IP 范围的划分。

	* 跨路由网络 DHCP 服务器。

		如果网络内部划分有多个子网并采用路由器进行连接，所以需要每个子网都可以请求有效的 DHCP 服务器，但子网内的客户机无法向其他子网的 DHCP 服务器发送请求。因此我们可以搭建一台 DHCP 服务器，同时在连接多个子网的路由器上设置 DHCP 中继代理就可以利用路由器转发 DHCP 消息，所有计算机都可以请求同一台 DHCP 服务器。

> 配置存在路由的网络需要注意：
> 
> * 存在 DHCP 服务器
> 
> 一个物理网络被划分为多个逻辑子网，在所有子网中必须存在一台 DHCP 服务器能够提供 TCP/IP 信息分配服务。
> 
> * 路由器中继代理设置
> 
> 路由器默认并不转发广播数据包，为了能够转送 DHCP Discover 消息，必须要在路由器上配置 DHCP 中继代理。


3. 80/20 规则

	为了确保 DHCP 服务的稳定性，应配置 DHCP 主服务器和 DHCP 辅助服务器，并合理划分 DHCP 服务器的地址池，防止为客户端分配重复的地址。
	一般主 DHCP 服务器管理 80% 的网络地址，辅助 DHCP 服务器管理剩余 20% 网络地址。日常工作中，由主 DHCP 服务器完成 TCP/IP 分配任务，在该服务器不可用时，辅助 DHCP 服务器才开始工作。

> 此规则适用于多子网的网络拓扑结构，并根据具体需求进行服务器规划。

### DNS 服务器

**DNS ( Domain Name Service, 域名服务 ) 是 Internet/Intranet 中最基础也非常重要的一项服务，它提供了网络访问中域名和 IP 地址的互相转换。**

#### 域名空间

DNS 是一个分布式数据库，命名系统采用层次的逻辑结构，如同一棵倒置的数，这个逻辑的属性结构称为域名空间。

> DNS 域名空间中，数的最大深度不超过 127 层，树中的每个节点最长可以存储 63 个字符。

1. 域和域名

	DNS 数的每个节点代表一个域，通过这些节点，对整个域名空间进行划分，成为一个层次结构。域名空间的每个域的名字通过域名表示。
	域名通常由一个完全正式域名（FQDN —— Fully Quanlified Domain Name）标识。FQDN 采用节点到树根的反向书写形式，并将每个节点用 “.” 分隔，来表示每个节点相对于 DNS 域树根的位置。

> 通常 FQDN 有严格的命名限制，长度不能超过 256 字节，只允许使用字符 a-z, 0-9, A-Z 和 -（减号）。.（点号）只允许在域名标志之间或者 FQDN 的结尾使用。
> 
> 域名不区分大小写。

2. Internet 域名空间

	Inernet 域名空间整体进行划分，由最顶层到下层，可以分成：根域、顶级域、二级域、子域，并且域中能够包含主机和子域。

	Internet 域名空间的最顶层是根域（root），其记录着 Internet 的重要 DNS 信息，由 Internet 域名注册授权机构管理，该机构把域名空间各部分的管理责任分配给连接到 Internet 的各个组织。

	DNS 根域下面是顶级域，也由 Internet 域名注册授权机构管理。共有 3 种类型的顶级域。

	* 组织域：采用 3 个自负的代号，表示 DNS 域中所包含的组织及其主要功能或活动。比如，com 为商业机构组织，edu 为教育机构组织， gov 为政府机构组织，mil 为军事机构组织，net 为网络机构组织，org 为非盈利机构组织，int 为国际机构组织。

	* 地址域：采用两个字符的国家或地区代号。比如，cn 代表中国，kr 代表韩国，us 代表美国。

	* 反向域：名字为 in-addr.arpa 的特殊域，用于将 IP 地址映射到域名（反向查询）。

3. 区

	区是 DNS 名称空间的一个连续部分，包含了一组存储在 DNS 服务器上的资源记录。

	每个区都位于一个特殊的节点，但区并不是域。DNS 域是名称空间的一个分支，而区一般是存储在文件中的 DNS 名称空间的一部分，可以包括多个域。一个域再分成几个部分，每个部分或区可以由一台 DNS 服务器控制。使用区的概念，DNS 服务器回答关于自己区中主机的查询，以及哪个区的授权服务器。

#### DNS 服务器分类

1. 主 DNS 服务器（Master 或 Primary）

	主 DNS 负责维护所管辖域的域名服务信息，并从本地磁盘中的取文件中加载域信息。

	配置主与服务器需要一整套的配置文件，包括主配置文件、正向域的区文件、反向域的区文件、高速缓存初始化文件和回送文件。

2. 辅助 DNS 服务器（Slave 或 Secondary）

	辅助 DNS 服务器用于分担主 DNS 服务器的查询负载。

	辅助 DNS 服务器上的区文件是从主服务器中转移出来并作为本地磁盘文件存储在辅助服务器中。因此，配置辅助 DNS 服务器只需配置主配置文件、高速缓存文件和会送文件即可。

3. 转发 DNS 服务器（Forwarder Name Server）

	转发 DNS 服务器可以向其他 DNS 服务器转发解析请求。

	当 DNS 服务器无法解析客户端的请求，则需要向其他制定的 DNS 服务器转发解析请求；其他 DNS 服务器完成解析并返回解析结果，转发 DNS 服务器将结果缓存在自己的 DNS 缓存中，并向客户端返回解析结果。

> 目前网络中所有的 DNS 服务器均被配置为转发 DNS 服务器，向指定的其他 DNS 服务器或者根域服务器转发自己无法解析的请求。

4. 唯高速缓存 DNS 服务器（Caching-only DNS server）

	唯高速缓存 DNS 服务器供本地网络上的客户机进行域名转换。

	唯高速缓存 DNS 服务器通过查询其他 DNS 服务器并将获得的信息存放在高速缓存中，为客户机查询提供服务。其提供的所有信息都是间接信息，因此并不是权威的服务器。


#### DNS 查询模式

1. 递归查询
	
	DNS 服务器收到请求后会在本机查找，如果没有查询结果，将会转发到其他 DNS 服务器查询，并将查询结果返回给客户机。

2. 转寄查询（又称迭代查询）

	DNS 服务器收到请求后会在本机查找，如果没有查询结果，将会返回给客户端另一台 DNS 服务器的 IP 地址，然后客户端向另一台 DNS 服务器查询结果。以此类推，直到查询到所需结果。如果最后一台 DNS 服务器也没有查到所需数据，则通知客户端查询失败。

> 一般在 DNS 服务器之间的查询便属于转寄查询。

#### 域名解析工作原理

1. 客户机提交域名解析请求，发送给本地的 DNS 服务器。

2. 本地 DNS 服务器收到请求后，首先查询本地缓存。如果缓存中有结果，则直接返回结果，否则，本地 DNS 服务器将把请求转发给根域名服务器。

3. 根域名服务器返回给本地 DNS 服务器所查询域的顶级域名服务器的地址。

4. 本地 DNS 服务器向该顶级域名服务器发送查询请求。

5. 顶级域名服务器查询缓存和记录，如果成功，将结果返回给客户机。否则，向客户机返回二级域名服务器的地址。

6. 本地 DNS 服务器向二级域名服务器发送查询请求。

7. 二级域名服务器查询并返回结果（重复转寄查询）。

8. 本地 DNS 服务器将得到的结果返回给客户机并缓存该结果。
	
> 正向解析：将域名解析为 IP 地址。
> 
> 反向解析：将 IP 地址解析为域名。反向解析可用于服务器身份验证。

#### 资源记录

服务器区文件（又称 DNS 数据库文件或简单数据库文件）中包含组成相关 DNS 域资源信息的资源记录（RR）。

1. SOA 资源记录

	每个区的开始处都包含了一个起始授权记录（Start of Authority Record），简称 SOA 记录。SOA 定义了域的全局参数，管理整个域。

	一个区文件中只允许存在唯一的 SOA 记录。

2. NS 资源记录

	名称服务器（NS）资源记录表示该区的授权服务器，即表示 SOA 资源记录中指定的该区的主服务器和辅助服务器。每个区在区根处都至少包含一个 NS 记录。

3. A 资源记录

	地址（A）资源记录把 FQDN 映射到 IP 地址。

4. PTR 资源记录

	相对于 A 资源记录，指针（PTR）记录把 IP 地址映射到 FQDN。

5. CNAME 资源记录

	规范名字（CNAME）资源记录创建特定 FQDN 的别名。

	用户可以使用 CNAME 来隐藏用户网络的实现细节。

6. MX 资源记录

	邮件交换（MX）资源记录为 DNS 域名指定邮件交换服务器。

#### FTP 服务器

##File Transfer Protocol 文件传输协议，具备强大的文件传输可靠性和更高的效率。##

#### FTP 工作原理

1. 客户端向服务器发出连接请求，同时客户端系统动态地打开一个大于 1024 的端口（比如 1031 端口）等候服务器连接。

2. 若 FTP 服务器在端口 21 监听到请求，则会在客户端的 1031 端口和服务器的 21 端口建立 FTP 会话链接。

3. 传输数据时，FTP 客户端动态地打开一个大于 1024 的端口（比如 1032 端口）连接到服务器的 20 端口，并在这两个端口之间进行数据传输。

4. 数据传输完毕，客户端 1032 端口和服务器 20 端口之间的自动断开。

5. 会话结束，FTP 客户端断开与 FTP 服务器的连接，客户端动态分配的端口自动释放。

#### FTP 服务的传输模式

FTP 服务有两种工作模式：主动传输模式（Active FTP）和被动传输模式（Passive FTP）。

1. 主动传输模式

	FTP 客户端随机打开一个大于 1024 的端口 N（比如 1031 端口）向服务器的 21 号端口发起连接。同时，客户端开启 N+1 号端口（1032）进行监听，并向服务器发出 PORT 1032 命令。

	服务器接收到命令后，会用其本地的 FTP 数据端口（通常是 20）来连接客户端指定的 1032 端口，并进行数据传输。

2. 被动传输模式

	FTP 客户端随机开启一个大于 1024 的端口 N（比如 1031 端口）向服务器的 21 号端口发起连接。同时，客户端开启 N+1 号端口（1032）并向服务器发送 PASV 命令。

	服务器接收到命令后，会开放一个大于 1024 的端口 P（比如 1521 端口）进行监听，然后用 PORT 1521 命令通知客户端。

	客户端收到命令后，会通过 1032 端口连接到服务器的 1521 端口，然后在两个端口之间进行数据传输。

> 主动传输模式是指服务器主动连接客户端的数据端口，被动传输模式是指服务器被动等待客户端连接。


> 被动传输模式的 FTP 服务通常用于处在内网的 FTP 客户端访问外界 FTP 服务器的情况。
> 
> 因为在这种情况下，防火墙通常会阻止外网的主机连接内网主机，而只允许内网主机连接外网主机。因此这种情况下，不能有效地使用主动传输模式，而被动传输模式却可以很好地工作。